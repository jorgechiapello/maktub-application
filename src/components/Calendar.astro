---
interface Props {
  matchId: number;
  matchName: string;
}

const { matchId, matchName } = Astro.props;

const hours = [];
for (let hour = 19; hour <= 24; hour++) {
  hours.push(`${hour}:00`);
}

const days = [];
const currentDate = new Date();
const currentDay = currentDate.getDay(); // 0 = Sunday, 1 = Monday, ...
const mondayOffset = currentDay === 0 ? -6 : 1 - currentDay; // If Sunday, go back 6 days, otherwise go back to Monday

const monday = new Date(currentDate);
monday.setDate(currentDate.getDate() + mondayOffset);

for (let i = 0; i < 7; i++) {
  const date = new Date(monday);
  date.setDate(monday.getDate() + i);
  days.push({
    date: date,
    dayName: new Intl.DateTimeFormat('es', { weekday: 'short' }).format(date),
    dayNumber: date.getDate(),
  });
}
---

<div class="bg-white rounded-lg shadow-lg p-6" id="calendar-container" data-match-id={matchId}>
  <div class="mb-6 text-center">
    <h2 class="text-2xl font-bold text-gray-900">
      Programa una cita con {matchName}
    </h2>
    <p class="text-gray-600 mt-2">
      Haz clic en múltiples horarios para indicar tu disponibilidad
    </p>
    <p class="text-sm text-primary mt-1">
      (Puedes seleccionar varios horarios)
    </p>
  </div>

  <div class="mb-6">
    <div class="grid grid-cols-7 gap-1">
      {/* Day headers */}
      {
        days.map((day) => (
          <div class="text-center font-medium text-gray-500 py-2">
            <div>{day.dayName}</div>
            <div class="text-sm">{day.dayNumber}</div>
          </div>
        ))
      }

      {/* Time slots grid */}
      {
        hours.map((hour) =>
          days.map((day) => {
            const slotId = `${day.date.toISOString().split('T')[0]}T${hour}`;
            return (
              <div
                class="time-slot aspect-square flex items-center justify-center border-2 rounded-lg cursor-pointer transition-all duration-200 border-gray-200"
                data-slot-id={slotId}
              >
                {hour}
              </div>
            );
          }),
        )
      }
    </div>
  </div>

  <div
    id="selected-slots"
    class="mb-6 p-4 bg-gray-50 rounded-lg shadow-sm hidden"
  >
    <div class="flex justify-between items-center mb-3">
      <h3 class="text-lg font-semibold text-gray-900">
        Horarios seleccionados
      </h3>
      <span
        id="slots-counter"
        class="px-3 py-1 bg-primary text-white rounded-full text-sm"
        >0 seleccionados</span
      >
    </div>
    <div id="selected-slots-list" class="space-y-2"></div>
  </div>

  <div class="flex justify-end space-x-3">
    <a
      href="/app"
      class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50"
    >
      Cancelar
    </a>
    <button
      id="confirm-button"
      class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary-dark disabled:opacity-50 disabled:cursor-not-allowed"
      disabled
    >
      Confirmar horarios
    </button>
  </div>
</div>

<script>
  let selectedSlots = new Set();

  
  function updateSelectedSlotsDisplay() {
    const elements = {
      container: document.getElementById('selected-slots'),
      list: document.getElementById('selected-slots-list'),
      button: document.getElementById('confirm-button'),
      counter: document.getElementById('slots-counter')
    };
    
    if (!elements.container || !elements.list || !elements.button || !elements.counter) return;
    
    const selectedArray = Array.from(selectedSlots);
    const hasSlots = selectedArray.length > 0;
    
    elements.container.classList.toggle('hidden', !hasSlots);
    elements.button.disabled = !hasSlots;
    
    elements.counter.textContent = `${selectedArray.length} ${selectedArray.length === 1 ? 'seleccionado' : 'seleccionados'}`;
    
    elements.list.innerHTML = hasSlots ? 
      selectedArray
        .sort()
        .map(slot => {
          const [date, time] = slot.split('T');
          const slotDate = new Date(date);
          const dayName = new Intl.DateTimeFormat('es', { weekday: 'long' })
            .format(slotDate)
            .replace(/^\w/, c => c.toUpperCase());
          
          return `
            <div class="text-gray-700 p-2 border-b border-gray-100">
              <span><strong>${dayName}</strong> a las <strong>${time}</strong></span>
            </div>
          `;
        })
        .join('') 
      : '';
  }

  function initializeCalendar() {
    setupTimeSlots();
    setupConfirmButton();
    updateSelectedSlotsDisplay();
  }
  
  function setupTimeSlots() {
    document.querySelectorAll('.time-slot').forEach(slot => {
      slot.removeEventListener('click', handleSlotClick);
      
      slot.addEventListener('click', handleSlotClick);
    });
  }
  
  function handleSlotClick(event) {
    event.preventDefault();
    event.stopPropagation();
    
    const slot = event.currentTarget;
    const slotId = slot.dataset.slotId;
    
    if (!slotId) return;
    
    if (selectedSlots.has(slotId)) {
      selectedSlots.delete(slotId);
      slot.classList.remove('bg-primary', 'text-white', 'border-primary');
    } else {
      selectedSlots.add(slotId);
      slot.classList.add('bg-primary', 'text-white', 'border-primary');
    }
    
    updateSelectedSlotsDisplay();
  }
  
  function setupConfirmButton() {
    const confirmButton = document.getElementById('confirm-button');
    if (!confirmButton) return;
    
    confirmButton.removeEventListener('click', handleConfirmClick);
    confirmButton.addEventListener('click', handleConfirmClick);
  }
  
  function handleConfirmClick() {
    if (selectedSlots.size === 0) {
      alert('Por favor, selecciona al menos un horario');
      return;
    }
    
    alert('¡Horarios confirmados con éxito!');
    window.location.href = '/app';
  }


  
  document.addEventListener('DOMContentLoaded', initializeCalendar);
  document.addEventListener('astro:page-load', initializeCalendar);
  
  initializeCalendar();
</script>
